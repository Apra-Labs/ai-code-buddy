<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Selection Hover - AI Code Buddy</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      line-height: 1.6;
      background: #f5f5f5;
    }

    h1 {
      color: #333;
      border-bottom: 3px solid #94BA33;
      padding-bottom: 10px;
    }

    .section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .terminal-output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 13px;
      line-height: 1.5;
      margin: 10px 0;
      overflow-x: auto;
    }

    .error {
      color: #ff6b6b;
    }

    .success {
      color: #90ee90;
    }

    code {
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
    }

    .instructions {
      background: #e3f2fd;
      border-left: 4px solid #2196F3;
      padding: 15px;
      margin: 20px 0;
    }

    .instructions h3 {
      margin-top: 0;
      color: #1976D2;
    }

    textarea {
      width: 100%;
      min-height: 100px;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 13px;
      resize: vertical;
    }

    textarea:focus {
      outline: none;
      border-color: #94BA33;
      box-shadow: 0 0 0 3px rgba(148, 186, 51, 0.1);
    }

    .test-case {
      border-left: 4px solid #94BA33;
      padding-left: 15px;
      margin: 15px 0;
    }

    .test-case h4 {
      color: #6d8c26;
      margin-top: 0;
    }
    #terminal-container {
      background: #000;
      border-radius: 6px;
      padding: 10px;
      margin: 10px 0;
    }

    #terminal {
      height: 400px;
    }

    .xterm {
      font-feature-settings: "liga" 0;
      position: relative;
      user-select: none;
      -ms-user-select: none;
      -webkit-user-select: none;
    }

    .xterm.focus,
    .xterm:focus {
      outline: none;
    }

    .xterm .xterm-helpers {
      position: absolute;
      top: 0;
      z-index: 5;
    }

    .xterm .xterm-helper-textarea {
      position: absolute;
      opacity: 0;
      left: -9999em;
      top: 0;
      width: 0;
      height: 0;
      z-index: -5;
      white-space: nowrap;
      overflow: hidden;
      resize: none;
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.3.0/css/xterm.css" />
  <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.3.0/lib/xterm.js"></script>
</head>
<body>
  <h1>üß™ Selection Hover Button Test Page</h1>

  <div class="instructions">
    <h3>üìã How to Test</h3>
    <ol>
      <li>Make sure the AI Code Buddy extension is loaded in Chrome</li>
      <li>Configure an AI provider in the extension popup</li>
      <li>Select any text in <strong>any section</strong> below (editable or readonly)</li>
      <li>A hover button should appear above your selection</li>
      <li>Click it to send the selected text to AI</li>
      <li><strong>Note:</strong> The hover button now works universally on all text!</li>
    </ol>
  </div>

  <div class="section">
    <div class="test-case">
      <h4>üî• Test Case 0: xterm.js Terminal (Like Sshwifty) - THE PROBLEM CASE</h4>
      <p><strong>THIS REPLICATES THE SSHWIFTY ISSUE!</strong> Select text in the terminal below:</p>
      <div id="terminal-container">
        <div id="terminal"></div>
      </div>
      <p style="background: #fff3cd; padding: 10px; border-radius: 4px; margin-top: 10px;">
        <strong>üêõ Known Issue:</strong> If hover button doesn't appear automatically, try <strong>right-clicking</strong> the selected text.
        This is the exact behavior seen in sshwifty.
      </p>
      <div style="margin-top: 10px;">
        <button onclick="addTerminalContent()" style="padding: 8px 16px; background: #94BA33; color: white; border: none; border-radius: 4px; cursor: pointer;">
          Add More Terminal Output
        </button>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="test-case">
      <h4>Test Case 1: Terminal Error Output (Readonly)</h4>
      <p>Select the error text below - hover button should appear:</p>
      <div class="terminal-output">
$ npm install express
<span class="error">npm ERR! code ENOENT
npm ERR! syscall open
npm ERR! path /home/user/package.json
npm ERR! errno -2
npm ERR! enoent ENOENT: no such file or directory, open '/home/user/package.json'
npm ERR! enoent This is related to npm not being able to find a file.
npm ERR! enoent</span>

npm ERR! A complete log of this run can be found in:
npm ERR!     /home/user/.npm/_logs/2025-10-14T12_00_00_000Z-debug.log
      </div>
    </div>
  </div>

  <div class="section">
    <div class="test-case">
      <h4>Test Case 2: Python Stack Trace (Readonly)</h4>
      <p>Select the traceback below - hover button should appear:</p>
      <div class="terminal-output">
$ python script.py
Traceback (most recent call last):
  File "script.py", line 10, in &lt;module&gt;
    result = process_data(input_file)
  File "script.py", line 5, in process_data
    with open(filename, 'r') as f:
<span class="error">FileNotFoundError: [Errno 2] No such file or directory: 'data.txt'</span>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="test-case">
      <h4>Test Case 3: Regular Text Paragraph (Readonly)</h4>
      <p>Select this paragraph or any part of it - hover button should appear:</p>
      <p>
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
        Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
        This text should trigger the selection hover button when selected.
      </p>
    </div>
  </div>

  <div class="section">
    <div class="test-case">
      <h4>Test Case 4: Bash Command with Output (Readonly)</h4>
      <p>Select the command or output - hover button should appear:</p>
      <div class="terminal-output">
$ docker ps
<span class="error">Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?</span>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="test-case">
      <h4>Test Case 5: Log File Content (Readonly)</h4>
      <p>Select any part of these logs - hover button should appear:</p>
      <div class="terminal-output">
2025-10-14 12:00:01 <span class="success">[INFO]</span> Application started successfully
2025-10-14 12:00:05 <span class="success">[INFO]</span> Connected to database
2025-10-14 12:00:10 <span class="error">[ERROR]</span> Failed to load configuration file
2025-10-14 12:00:10 <span class="error">[ERROR]</span> ConfigurationError: config.yaml not found
2025-10-14 12:00:15 <span class="error">[FATAL]</span> Application shutting down due to critical error
      </div>
    </div>
  </div>

  <div class="section">
    <div class="test-case">
      <h4>Test Case 6: Editable Textarea (hover button SHOULD appear)</h4>
      <p><strong>Important:</strong> Select text in this textarea - hover button <strong>SHOULD</strong> appear now:</p>
      <textarea placeholder="Type or paste your code here...
Example:
#!/bin/bash
echo 'Hello World'

The selection hover button SHOULD appear when you select text in this editable textarea.
This tests that the hover button now works universally on all text (editable and readonly)."></textarea>
    </div>
  </div>

  <div class="section">
    <div class="test-case">
      <h4>Test Case 6.5: Scrollable Textarea (POSITIONING FIX TEST)</h4>
      <p><strong>This tests the positioning fix for scrollable containers:</strong></p>
      <ol style="font-size: 13px; line-height: 1.8;">
        <li>Scroll down inside the textarea below to line 30-40</li>
        <li>Select some text in the middle of the visible area</li>
        <li>Hover button should appear <strong>directly above the selection</strong></li>
        <li>Scroll up or down - button should <strong>stay with the selection</strong></li>
        <li>The button should <strong>NOT</strong> move out of the visible area</li>
      </ol>
      <textarea style="height: 200px; overflow-y: scroll;" readonly>Line 1: This is a scrollable textarea test
Line 2: Scroll down to test the positioning fix
Line 3: The hover button should stay above the selection
Line 4: Even when you scroll the textarea content
Line 5: This tests the fixed positioning fix
Line 6: Previously, the button would move higher as you scrolled
Line 7: Now it should stay correctly positioned
Line 8: Try selecting text anywhere in this textarea
Line 9: Then scroll up or down
Line 10: The button should move with the selection
Line 11: Lorem ipsum dolor sit amet, consectetur adipiscing elit
Line 12: Sed do eiusmod tempor incididunt ut labore et dolore
Line 13: Magna aliqua. Ut enim ad minim veniam
Line 14: Quis nostrud exercitation ullamco laboris
Line 15: Nisi ut aliquip ex ea commodo consequat
Line 16: Duis aute irure dolor in reprehenderit
Line 17: In voluptate velit esse cillum dolore
Line 18: Eu fugiat nulla pariatur. Excepteur sint
Line 19: Occaecat cupidatat non proident, sunt in
Line 20: Culpa qui officia deserunt mollit anim
Line 21: Id est laborum. Sed ut perspiciatis unde
Line 22: Omnis iste natus error sit voluptatem
Line 23: Accusantium doloremque laudantium totam
Line 24: Rem aperiam eaque ipsa quae ab illo
Line 25: Inventore veritatis et quasi architecto
Line 26: Beatae vitae dicta sunt explicabo
Line 27: Nemo enim ipsam voluptatem quia voluptas
Line 28: Sit aspernatur aut odit aut fugit
Line 29: Sed quia consequuntur magni dolores eos
Line 30: *** SELECT THIS LINE AND SCROLL ***
Line 31: Qui ratione voluptatem sequi nesciunt
Line 32: Neque porro quisquam est, qui dolorem
Line 33: Ipsum quia dolor sit amet, consectetur
Line 34: Adipisci velit, sed quia non numquam
Line 35: Eius modi tempora incidunt ut labore
Line 36: Et dolore magnam aliquam quaerat voluptatem
Line 37: Ut enim ad minima veniam, quis nostrum
Line 38: Exercitationem ullam corporis suscipit
Line 39: Laboriosam, nisi ut aliquid ex ea
Line 40: Commodi consequatur? Quis autem vel eum
Line 41: Iure reprehenderit qui in ea voluptate
Line 42: Velit esse quam nihil molestiae consequatur
Line 43: Vel illum qui dolorem eum fugiat quo
Line 44: Voluptas nulla pariatur?
Line 45: End of test content</textarea>
      <p style="background: #fff3cd; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 13px; line-height: 1.6;">
        <strong>‚úÖ Expected:</strong> Button appears above selection (or below if selection is near top of viewport).<br>
        <strong>‚úÖ Smart Positioning:</strong> Button repositions intelligently when selection is near viewport edges.<br>
        <strong>‚ùå Bug (before fix):</strong> Button would move out of view as you scroll inside textarea.
      </p>
    </div>
  </div>

  <div class="section">
    <div class="test-case">
      <h4>Test Case 7: Code Snippet (Readonly)</h4>
      <p>Select this inline code <code>npm install --save express</code> or the block below:</p>
      <div class="terminal-output">
function calculateTotal(items) {
  let total = 0;
  for (let item of items) {
    total += item.price * item.quantity;
  }
  return total;
}
      </div>
    </div>
  </div>

  <div class="section">
    <div class="test-case">
      <h4>Test Case 8: Success Output (Readonly)</h4>
      <p>Select the successful output - hover button should still appear:</p>
      <div class="terminal-output">
$ git status
On branch main
Your branch is up to date with 'origin/main'.

nothing to commit, working tree clean
      </div>
    </div>
  </div>

  <div class="instructions">
    <h3>‚úÖ Expected Behavior</h3>
    <ul>
      <li><strong>All content (Test Cases 1-8):</strong> Hover button appears above selection</li>
      <li><strong>Universal support:</strong> Works on readonly text, editable textareas, and input fields</li>
      <li><strong>Button appearance:</strong> Smooth fade-in animation, pill-shaped, Apra Labs green</li>
      <li><strong>Button position:</strong> Centered above selection (like Medium)</li>
      <li><strong>Click behavior:</strong> Sends text to AI, shows loading state, then modal</li>
      <li><strong>Modal:</strong> Shows AI analysis with editable textareas and action buttons</li>
    </ul>
  </div>

  <div class="instructions" style="background: #fff3cd; border-left-color: #ffc107;">
    <h3>üêõ Troubleshooting</h3>
    <ul>
      <li><strong>Button not appearing:</strong> Check extension is loaded and provider configured</li>
      <li><strong>Button doesn't appear in textarea:</strong> Bug! It should appear on all text</li>
      <li><strong>Button position wrong:</strong> Try scrolling or resizing window</li>
      <li><strong>No AI response:</strong> Check console (F12) for errors, verify API key</li>
    </ul>
  </div>

  <script>
    // Initialize xterm.js terminal (replicating sshwifty behavior)
    let term;
    let termContent = [];

    function initTerminal() {
      if (!window.Terminal) {
        console.error('xterm.js not loaded yet, retrying...');
        setTimeout(initTerminal, 100);
        return;
      }

      term = new Terminal({
        cursorBlink: true,
        cursorStyle: 'block',
        fontSize: 14,
        fontFamily: 'Monaco, Menlo, Consolas, monospace',
        theme: {
          background: '#000000',
          foreground: '#ffffff',
          cursor: '#ffffff'
        },
        rows: 24,
        cols: 80
      });

      term.open(document.getElementById('terminal'));

      // Add initial content
      term.writeln('Welcome to xterm.js Test Terminal (like Sshwifty)');
      term.writeln('================================================');
      term.writeln('');
      term.writeln('$ npm install express');
      term.writeln('\x1b[31mnpm ERR! code ENOENT\x1b[0m');
      term.writeln('\x1b[31mnpm ERR! syscall open\x1b[0m');
      term.writeln('\x1b[31mnpm ERR! path /home/user/package.json\x1b[0m');
      term.writeln('\x1b[31mnpm ERR! errno -2\x1b[0m');
      term.writeln('');
      term.writeln('$ python script.py');
      term.writeln('Traceback (most recent call last):');
      term.writeln('  File "script.py", line 10, in <module>');
      term.writeln('    result = process_data(input_file)');
      term.writeln('\x1b[31mFileNotFoundError: [Errno 2] No such file or directory\x1b[0m');
      term.writeln('');
      term.writeln('$ docker ps');
      term.writeln('\x1b[31mCannot connect to the Docker daemon. Is the docker daemon running?\x1b[0m');
      term.writeln('');
      term.writeln('\x1b[32m‚úì Try selecting any text above!\x1b[0m');
      term.writeln('\x1b[33m‚ö† If hover button doesn\'t appear, right-click the selection\x1b[0m');

      // Debug: Log xterm.js events
      console.log('üîç xterm.js Terminal initialized');
      console.log('üîç Terminal element:', term.element);
      console.log('üîç Terminal textarea:', term.textarea);

      // Try to intercept xterm selection events
      if (term.textarea) {
        term.textarea.addEventListener('mouseup', (e) => {
          console.log('üñ±Ô∏è xterm textarea mouseup event', e);
        }, true);
      }

      // Listen to xterm's own selection event (if available)
      term.onSelectionChange(() => {
        const selection = term.getSelection();
        console.log('üìù xterm selection changed:', selection);
      });
    }

    function addTerminalContent() {
      if (!term) return;

      const samples = [
        '$ tail -f /var/log/nginx/error.log',
        '\x1b[31m2025/10/15 14:23:45 [error] 1234#1234: *56789 connect() failed\x1b[0m',
        '',
        '$ systemctl status myapp',
        '\x1b[31m‚óè myapp.service - My Application\x1b[0m',
        '\x1b[31m   Loaded: loaded (/etc/systemd/system/myapp.service)\x1b[0m',
        '\x1b[31m   Active: failed (Result: exit-code)\x1b[0m',
        '',
        '$ grep ERROR application.log',
        '\x1b[31m[2025-10-15 14:30:00] ERROR: Database connection timeout\x1b[0m',
        '\x1b[31m[2025-10-15 14:30:15] ERROR: Failed to authenticate user\x1b[0m',
        ''
      ];

      samples.forEach(line => term.writeln(line));
      term.writeln('\x1b[32m‚úì More content added! Try selecting it.\x1b[0m');
    }

    // Initialize terminal when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTerminal);
    } else {
      initTerminal();
    }

    // Add global event listener to see all mouseup events
    document.addEventListener('mouseup', (e) => {
      console.log('üåç Global mouseup event:', {
        target: e.target,
        tagName: e.target.tagName,
        className: e.target.className,
        inTerminal: e.target.closest('#terminal') !== null
      });
    }, true);  // Use capture phase

    // Monitor selection changes
    document.addEventListener('selectionchange', () => {
      const selection = window.getSelection();
      if (selection.toString().length > 0) {
        console.log('üìã Document selection changed:', {
          text: selection.toString().substring(0, 50),
          rangeCount: selection.rangeCount
        });
      }
    });
  </script>

</body>
</html>
